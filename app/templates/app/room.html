{% extends 'app/base.html' %}


{% block body %}

{{chatroom.name }}

<div id="chat-messages">
    {% for m in messages %}
        {{m.user.username}}&nbsp;:&nbsp;{{m.message_content}}
        <br>
    {% endfor %}

</div>

<form method="post">
    {% csrf_token %}
    <input type="text" id="message-input" name="message" placeholder="Enter message">
    <button id='send-button' type="submit">Send</button>
</form>

{{chatroom.slug|json_script:"json-chatroomname"}}
{{request.user.username|json_script:"json-username"}}

<script>
    const chatRoomName = JSON.parse(document.getElementById('json-chatroomname').textContent)
    const username = JSON.parse(document.getElementById('json-username').textContent)
    const chatSocket = new WebSocket(
        'ws://'
        +window.location.host
        +'/ws/'
        +chatRoomName
        +'/'
    )

    chatSocket.onmessage = function(e){
    //  console.log('this is a message') 
    const data = JSON.parse(e.data)
    if(data.message){
            console.log('Received message to client is', data.message)
            let html = data.username + " : " + data.message + '</br>'
            document.getElementById('chat-messages').innerHTML += html

        }else{
            alert('The message was empty')
        }  
    }

    chatSocket.onclose = function(e){
        
        console.log('socket closed')
        
    }

    document.getElementById('send-button').onclick = function(e){
        e.preventDefault()
        const messageInput = document.getElementById('message-input')
        const message = messageInput.value
        console.log(message)
        

        chatSocket.send(JSON.stringify({
            'message': message,
            'username': username,
            'room': chatRoomName,

        }))
        messageInput.value = ''
    }


</script>

{% endblock  %}